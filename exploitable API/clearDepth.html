<html>
<head><title>webgl test</title></head>
<body>


<canvas id='myCanvas' width='256' height='256'></canvas>
<div id="res"> </div>
<script>
String.prototype.hashCode = function() {
  var hash = 0, i, chr;
  if (this.length === 0) return hash;
  for (i = 0; i < this.length; i++) {
	chr   = this.charCodeAt(i);
	hash  = ((hash << 5) - hash) + chr;
	hash |= 0; // Convert to 32bit integer
  }
  return hash;
};
</script>	
<script>


var canvas = document.getElementById("myCanvas");
var gl = canvas.getContext('webgl',{ antialias: false, depth: true });

if (!gl) {
	console.log('can not use webgl');
}

gl.getExtension('EXT_frag_depth');
gl.enable(gl.DEPTH_TEST);
gl.enable(gl.POLYGON_OFFSET_FILL);
gl.polygonOffset(2, 3);

var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
console.log( gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) );
console.log( gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) );

function loadShader(type, shaderSource) {
  var shader = gl.createShader(type);
  gl.shaderSource(shader, shaderSource);
  gl.compileShader(shader);

  if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
      alert("Error compiling shader" + gl.getShaderInfoLog(shader));
      gl.deleteShader(shader);   
      return null;
  }
  return shader;  
}


var vertexShaderSource = `
  void main() {
    gl_Position = vec4(0.0, 0.0, 1.0, 1.0);
    gl_PointSize = 20.0;
  }
`
	
var fragmentShaderSource = `
  #extension GL_EXT_frag_depth : enable
  precision mediump float;
  uniform float depth;
  void main() {
    gl_FragColor = vec4(1.0, 0, 0, 1.0);
	gl_FragDepthEXT = depth;
  }                                       
`


var vertexShader = loadShader(gl.VERTEX_SHADER, vertexShaderSource);
var fragmentShader = loadShader(gl.FRAGMENT_SHADER, fragmentShaderSource);

var shaderProgram = gl.createProgram();
gl.attachShader(shaderProgram, vertexShader);
gl.attachShader(shaderProgram, fragmentShader);
gl.linkProgram(shaderProgram);

if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
	alert("Failed to setup shaders");
}

gl.useProgram(shaderProgram);

var depth = gl.getUniformLocation(shaderProgram, 'depth');

function probe_depth(target){
  var left = 0, right = 9999999, mid;
  var pixel = new Uint8Array(1*1*4);
  while(left + 1 < right){
    mid = Math.round((right + left)/2);

    gl.uniform1f(depth, mid/10000000);
    
    gl.clearDepth(target);		//	��987654358		987654359 ��
    gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
    gl.drawArrays(gl.POINTS, 0, 1);

    gl.readPixels(128, 127, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixel);
//    console.log(mid/10000000, " : ", pixel[0]);
    if(pixel[0] == 255){		//̫��
      left = mid;
    }else{
      right = mid;
    }
  }
  return left;
}

var x = [0.09213860,0.28048157,0.60803554,0.45109829,0.92584479,0.96715992,0.96412241,0.52364487,0.09476011,0.42285275];
var res = [];
for(let i=0;i<1;i++)
  res.push(probe_depth(x[i]));

var div = document.getElementById('res');
div.innerHTML = "Your fingerprint: "+ res.join('_').hashCode();//canvas.toDataURL().hashCode();

</script>

</body>
</html>